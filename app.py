import streamlit as st
import pandas as pd
from datetime import datetime
import time

# -----------------------------------------------------------
# 1. ê¸°ì´ˆ ì„¤ì • ë° ë°ì´í„° ì •ì˜
# -----------------------------------------------------------
st.set_page_config(page_title="ë² ìŠ¤íŠ¸ í™”í•™ ê¸°ê³„ ê²¬ì  ì‹œìŠ¤í…œ", layout="wide")

# URLì—ì„œ ê²¬ì  IDê°€ ìˆëŠ”ì§€ í™•ì¸ (ë§í¬ íƒ€ê³  ë“¤ì–´ì™”ì„ ë•Œìš©)
query_params = st.query_params
current_quote_id = query_params.get("quote_id", None)

st.title("ğŸ­ ë² ìŠ¤íŠ¸ í™”í•™ ê¸°ê³„ - ì „ë¬¸ê°€ìš© ê²¬ì  ì‹œìŠ¤í…œ")

# --- (A) ë°ì´í„° ë§¤í•‘ (ì‚¬ì¥ë‹˜ì´ ë¶ˆëŸ¬ì£¼ì‹  ê·œì¹™ë“¤) ---
# 1. ì„¤ë¹„ë³„ ìš©ëŸ‰ ë¦¬ìŠ¤íŠ¸
CAPACITY_MAP = {
    "ë² ìŠ¤íŠ¸ë°€": [5, 10, 30, 40, 50],
    "í¼í™íŠ¸ë°€": [5, 10, 30, 40, 50],
    "íƒ‘ë°€": [20, 30, 40, 50],
    "ë°”ìŠ¤ì¼“ë°€": ["1~4L", "20~40L", "100L", "200L", "300L", "500L", "1000L", "3000L", "5000L"],
    "ì¶©ì§„ê¸°": ["1êµ¬", "2êµ¬"]
}

# 2. ë©”ì¸ ëª¨í„° ìë™ ì„ íƒ ê·œì¹™ (ì„¤ë¹„ìš©ëŸ‰ -> ëª¨í„°ë§ˆë ¥)
MAIN_MOTOR_AUTO_MAP = {
    "ë² ìŠ¤íŠ¸ë°€": {5: "10HP", 10: "15HP", 20: "20HP", 30: "30HP", 40: "40HP", 50: "50HP"},
    "í¼í™íŠ¸ë°€": {5: "10HP", 10: "15HP", 20: "20HP", 30: "30HP", 40: "40HP", 50: "50HP"},
    "íƒ‘ë°€": {20: "30HP", 30: "40HP", 40: "50HP", 50: "60HP"},
    "ë°”ìŠ¤ì¼“ë°€": {"1~4L": "2HP", "20~40L": "5HP", "100L": "20HP", "200L": "30HP", "300L": "40HP", "500L": "50HP", "1000L": "60HP", "3000L": "125HP", "5000L": "200HP"}
}

# 3. ì„œë¸Œ ëª¨í„° ìë™ ì„ íƒ ê·œì¹™
SUB_MOTOR_AUTO_MAP = {
    "ë² ìŠ¤íŠ¸ë°€": {5: "1HP", 10: "2HP", 20: "2HP", 30: "2HP", 40: "2HP", 50: "3HP"},
    "í¼í™íŠ¸ë°€": {5: "1HP", 10: "2HP", 20: "2HP", 30: "2HP", 40: "2HP", 50: "3HP"},
    "íƒ‘ë°€": {20: "2HP", 30: "2HP", 40: "2HP", 50: "3HP"},
    "ë°”ìŠ¤ì¼“ë°€": {"1~4L": "ì—†ìŒ", "20~40L": "ì—†ìŒ", "100L": "5HP", "200L": "10HP", "300L": "10HP", "500L": "15HP", "1000L": "20HP", "3000L": "50HP", "5000L": "100HP"}
}

# 4. ì„ íƒ ê°€ëŠ¥í•œ ëª¨í„° ì „ì²´ ë¦¬ìŠ¤íŠ¸ (ë³€ê²½ ê°€ëŠ¥í•˜ë„ë¡)
ALL_MOTORS = ["ì—†ìŒ", "1HP", "2HP", "3HP", "5HP", "10HP", "15HP", "20HP", "30HP", "40HP", "50HP", "60HP", "75HP", "100HP", "125HP", "200HP"]

# -----------------------------------------------------------
# 2. UI ë° ë¡œì§ êµ¬í˜„
# -----------------------------------------------------------

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” (ìë™ ì„ íƒ ë¡œì§ì„ ìœ„í•´ í•„ìš”)
if 'last_capacity' not in st.session_state:
    st.session_state['last_capacity'] = None

with st.sidebar:
    st.header("1. ê²¬ì  ìƒì„¸ ì¡°ê±´")
    
    # 1.1 ì„¤ë¹„ ì¢…ë¥˜
    equip_type = st.selectbox(
        "ì„¤ë¹„ ì¢…ë¥˜", 
        ["ë² ìŠ¤íŠ¸ë°€", "í¼í™íŠ¸ë°€", "íƒ‘ë°€", "ë°”ìŠ¤ì¼“ë°€", "ë¯¹ì„œ", "ì§„ê³µíƒˆí¬ê¸°", "ì¶©ì§„ê¸°"]
    )

    # 1.2 ì„¤ë¹„ ìš©ëŸ‰ ë¡œì§
    capacity = None
    if equip_type in ["ë¯¹ì„œ", "ì§„ê³µíƒˆí¬ê¸°"]:
        st.info("ğŸ’¡ ë¯¹ì„œ/íƒˆí¬ê¸°ëŠ” ë©”ì¸ ëª¨í„° ìš©ëŸ‰ì„ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.")
    elif equip_type == "ì¶©ì§„ê¸°":
        capacity = st.selectbox("ì¶©ì§„êµ¬ ìˆ˜", CAPACITY_MAP["ì¶©ì§„ê¸°"])
    else:
        # ë°€ ì¢…ë¥˜ (Capacity Mapì— ìˆëŠ” ê²ƒë“¤)
        capacity = st.selectbox("ì„¤ë¹„ ìš©ëŸ‰", CAPACITY_MAP.get(equip_type, []))

    # --- ì—¬ê¸°ì„œë¶€í„° 'ìë™ ì„ íƒ' ë§ˆë²•ì´ ì¼ì–´ë‚©ë‹ˆë‹¤ ---
    
    # ê¸°ë³¸ê°’ ì„¤ì •
    default_main_index = 0
    default_sub_index = 0

    # (A) ìš©ëŸ‰ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œ, ì¶”ì²œ ëª¨í„° ì°¾ê¸°
    if capacity and equip_type in MAIN_MOTOR_AUTO_MAP:
        # 1. ë©”ì¸ ëª¨í„° ì¶”ì²œê°’ ì°¾ê¸°
        rec_main = MAIN_MOTOR_AUTO_MAP[equip_type].get(capacity, "ì—†ìŒ")
        if rec_main in ALL_MOTORS:
            default_main_index = ALL_MOTORS.index(rec_main)
        
        # 2. ì„œë¸Œ ëª¨í„° ì¶”ì²œê°’ ì°¾ê¸°
        rec_sub = SUB_MOTOR_AUTO_MAP.get(equip_type, {}).get(capacity, "ì—†ìŒ")
        if rec_sub in ALL_MOTORS:
            default_sub_index = ALL_MOTORS.index(rec_sub)

    # 1.3 ë©”ì¸ ëª¨í„° ì¶œë ¥ (Userê°€ ë°”ê¿€ ìˆ˜ ìˆìŒ)
    if equip_type == "ì¶©ì§„ê¸°":
        main_hp = "ì—†ìŒ"
        st.text("ë©”ì¸ ëª¨í„°: ì—†ìŒ")
    elif equip_type in ["ë¯¹ì„œ", "ì§„ê³µíƒˆí¬ê¸°"]:
        # ë¯¹ì„œëŠ” ìë™ ì„ íƒ ì—†ì´ ê·¸ëƒ¥ ì„ íƒ
        main_hp = st.selectbox("ë©”ì¸ ëª¨í„° ì¶œë ¥", ALL_MOTORS[1:]) # 'ì—†ìŒ' ì œì™¸í•˜ê³  ë³´ì—¬ì¤Œ
    else:
        # ë°€ ì¢…ë¥˜ëŠ” ìë™ ì„ íƒëœ ê°’ì„ Defaultë¡œ ë³´ì—¬ì£¼ë˜, ìˆ˜ì • ê°€ëŠ¥
        # keyë¥¼ ë„£ì–´ì„œ ë¦¬ì…‹ ë°©ì§€, indexë¥¼ ë„£ì–´ì„œ ìë™ ì„ íƒ ë°˜ì˜
        main_hp = st.selectbox("ë©”ì¸ ëª¨í„° ì¶œë ¥", ALL_MOTORS, index=default_main_index)

    # 1.4 ì„œë¸Œ ëª¨í„° ì¶œë ¥
    if equip_type in ["ë¯¹ì„œ", "ì§„ê³µíƒˆí¬ê¸°", "ì´ì†¡íŒí”„", "ì¶©ì§„ê¸°"]:
        sub_hp = "ì—†ìŒ"
        st.text("ì„œë¸Œ ëª¨í„°: ì—†ìŒ")
    else:
        sub_hp = st.selectbox("ì„œë¸Œ ëª¨í„° ì¶œë ¥", ALL_MOTORS, index=default_sub_index)

    st.divider()

    # 1.5 ë°©í­ íƒ€ì…
    explosion_type = st.radio("ë°©í­ íƒ€ì…", ["ë¹„ë°©í­", "EG3", "d2G4 (ë‚´ì••ë°©í­)"])

    # 1.6 ì¬ì§ˆ
    material = st.radio("ì ‘ì•¡ë¶€ ì¬ì§ˆ", ["ì¼ë°˜ ì²  (SS400)", "ìŠ¤í…Œì¸ë¦¬ìŠ¤ (SUS304)"])

    # 1.7 ê¸°íƒ€ ì˜µì…˜
    options = st.text_area("ê¸°íƒ€ ìš”ì²­ì‚¬í•­ (ì˜µì…˜)", placeholder="ì˜ˆ: ë¦¬í”„íŠ¸ í–‰ì • 500mm ì¶”ê°€, ì¸ë²„í„° ë©”ì´ì»¤ LSë¡œ ë³€ê²½ ë“±")

    # [ê²¬ì  ì‚°ì¶œ ë° ì €ì¥] ë²„íŠ¼
    save_btn = st.button("ğŸ’¾ ê²¬ì  ì‚°ì¶œ ë° DB ì €ì¥", type="primary")


# -----------------------------------------------------------
# 3. ê²¬ì  ê²°ê³¼ ì²˜ë¦¬ ë° ë§í¬ ìƒì„±
# -----------------------------------------------------------
if save_btn:
    # 3.1 ê²¬ì  ID ìƒì„± (YYMMDDHHMM)
    now = datetime.now()
    quote_id = now.strftime("%y%m%d%H%M")
    
    # 3.2 ë§í¬ ìƒì„± (í˜„ì¬ ì£¼ì†Œ + ID)
    # ë¡œì»¬ì—ì„œ ëŒë¦´ ë• localhost, ë°°í¬í•˜ë©´ ê·¸ ì£¼ì†Œê°€ ë¨
    base_url = "https://share.streamlit.io/..." # ë°°í¬ í›„ ì‚¬ì¥ë‹˜ ì‹¤ì œ ì£¼ì†Œë¡œ ë°”ë€ŒëŠ” ë¶€ë¶„
    # ì‹¤ì œë¡œëŠ” í˜„ì¬ ë¸Œë¼ìš°ì € ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¤ê¸° í˜ë“œë‹ˆ, ë°°í¬ëœ ì£¼ì†Œë¥¼ ì•ˆë‹¤ë©´ í•˜ë“œì½”ë”©í•˜ê±°ë‚˜
    # ìŠ¤íŠ¸ë¦¼ë¦¿ URL êµ¬ì¡°ìƒ ì•„ë˜ì²˜ëŸ¼ ì¿¼ë¦¬ë¥¼ ë¶™ì…ë‹ˆë‹¤.
    quote_link = f"?quote_id={quote_id}"

    # 3.3 ì €ì¥í•  ë°ì´í„° ì •ë¦¬
    save_data = {
        "ê²¬ì ID": quote_id,
        "ë‚ ì§œ": now.strftime("%Y-%m-%d"),
        "ì„¤ë¹„ì¢…ë¥˜": equip_type,
        "ìš©ëŸ‰": str(capacity) if capacity else "-",
        "ë©”ì¸ëª¨í„°": main_hp,
        "ì„œë¸Œëª¨í„°": sub_hp,
        "ë°©í­": explosion_type,
        "ì¬ì§ˆ": material,
        "ì˜µì…˜": options,
        "ë§í¬": quote_link
    }

    # --- í™”ë©´ í‘œì‹œ ---
    st.success(f"ê²¬ì ì´ ì‚°ì¶œë˜ì—ˆìŠµë‹ˆë‹¤! (ID: {quote_id})")
    
    col1, col2 = st.columns([1, 2])
    
    with col1:
        st.subheader("ğŸ“‹ ê²¬ì  ìš”ì•½")
        st.write(f"**ì„¤ë¹„:** {equip_type} {capacity if capacity else ''}")
        st.write(f"**ëª¨í„°:** Main {main_hp} / Sub {sub_hp}")
        st.write(f"**ì‚¬ì–‘:** {explosion_type} / {material}")
        st.info("ğŸ’µ ì˜ˆìƒ ê²¬ì ê°€: (ë‹¨ê°€í‘œ ì—°ë™ ë¡œì§ ì ìš© ì˜ˆì •)") 
        # (ì—¬ê¸°ì— ì´ì „ì— ë§Œë“  ë‹¨ê°€ ê³„ì‚° ë¡œì§ì„ ì—°ê²°í•˜ë©´ ë©ë‹ˆë‹¤)

    with col2:
        st.subheader("ğŸ’¾ DB ì €ì¥ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
        st.caption("ì•„ë˜ ë‚´ìš©ì´ 'ê²¬ì DB' ì‹œíŠ¸ì— ì €ì¥ë©ë‹ˆë‹¤.")
        df_save = pd.DataFrame([save_data])
        st.dataframe(df_save)
        
        st.warning("âš ï¸ ì¤‘ìš”: êµ¬ê¸€ ì‹œíŠ¸ì— 'ì“°ê¸°(ì €ì¥)'ë¥¼ í•˜ë ¤ë©´ ê¶Œí•œ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        st.code(f"ìƒì„±ëœ ê²¬ì  ë§í¬: {quote_link}")
        
    # ì—¬ê¸°ì— ì‹¤ì œ êµ¬ê¸€ ì‹œíŠ¸ ì €ì¥ ì½”ë“œ(gspread)ê°€ ë“¤ì–´ê°€ì•¼ í•¨ (ì•„ë˜ ì„¤ëª… ì°¸ì¡°)

# -----------------------------------------------------------
# 4. ë§í¬ íƒ€ê³  ë“¤ì–´ì™”ì„ ë•Œ (ê³¼ê±° ê²¬ì  ì¡°íšŒ)
# -----------------------------------------------------------
if current_quote_id:
    st.divider()
    st.subheader(f"ğŸ” ê³¼ê±° ê²¬ì  ì¡°íšŒ ì¤‘ (ID: {current_quote_id})")
    st.info("DBê°€ ì—°ê²°ë˜ë©´ í•´ë‹¹ IDì˜ ìƒì„¸ ê²¬ì  ë‚´ìš©ì„ ì´ê³³ì— ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.")
